OpenBSD 3.2 install script for OpenHack 2002 machines maintained by eWEEK
(4 firewalls, mail server, DNS server, www.openhack.com Web server)

Using 2002-10-03 21:25 OpenBSD snapshot (which is final 3.2 code)

- Timothy Dyck, eWEEK Labs

==

hardware setup (F2 key):

set hardware time to UTC (+7 with Daylight Savings)
disable onboard Intel Pro/100 VE NIC
disable onboard audio

==

install,upgrade or shell?:	i[ENTER]
terminal type?:			vt220[ENTER]
select kbd encoding table?:	n[ENTER]
proceed with install?:		y[ENTER]

==

disk partitioning:

root disk is [wd0]?:	[ENTER]
use all of disk?:	y[ENTER]

		d a[ENTER]

		a a[ENTER]
offset:		[ENTER]
size:		80m[ENTER]
FS type:	[ENTER]
mount point:	/[ENTER]

		a b[ENTER]
offset:		[ENTER]
size:		1g[ENTER]
FS type (swap):	[ENTER]

		a d[ENTER]
offset:		[ENTER]
size:		80m[ENTER]
FS type:	[ENTER]
mount point:	/tmp[ENTER]

		a e[ENTER]
offset:		[ENTER]
size:		10g[ENTER]
FS type:	[ENTER]
mount point:	/var[ENTER]

		a g[ENTER]
offset:		[ENTER]
size:		10g[ENTER]
FS type:	[ENTER]
mount point:	/usr[ENTER]

		a h[ENTER]
offset:		[ENTER]
size:		10g[ENTER]
FS type:	[ENTER]
mount point:	/home[ENTER]

p[ENTER]
w[ENTER]
q[ENTER]

wd0d is /tmp?:	[ENTER]
wd0e is /var?:	[ENTER]
wd0g is /usr?:	[ENTER]
wd0h is /home?:	[ENTER]
wd0d is /tmp?:	done[ENTER]

proceed?:	y[ENTER]

==

network configuration:

short hostname?:	{hostname}
configure network?:	y[ENTER]
DNS domain name:	openhack.com

(configure network cards, gw, dns)

==

(enter root password)

==

install sets:

where are the install sets?:	c[ENTER]
which CD-ROM?:			cd0[ENTER] (cd0 is the CDRW drive on the Microns)
pathname?:			/[ENTER]
	
file name?:			-misc32.tgz[ENTER]
file name?:			-comp32.tgz[ENTER]
file name?:			-game32.tgz[ENTER]

(exactly the following four sets should be checked: base32.tgz, etc32.tgz, man32.tgz, bsd)

file name?:			done[ENTER]
ready to install sets?:		y[ENTER]
extract more sets?:		n[ENTER]
run X Windows?:			n[ENTER]
what timezone?:			US/Pacific[ENTER]

at # prompt:

halt[ENTER]

==

system configuration:

login as root

change root shell to ksh
	usermod -s /bin/ksh root
	(.profile is the ksh init script)

edit /root/.profile and add
	# T. Dyck additions
	
	# aliases
	alias ls='ls -Fla'

logout and login again as root

add eweek user (add them to "wheel" group so eweek can su)
	adduser[ENTER] (default shell is ksh, accept other defaults)
	(name eweek, long name "eWEEK Labs", add user to "wheel" group, accept other defaults)

check group membership:
	groups eweek (should see "eweek wheel")
	(to do group change separately, do "usermod -G wheel eweek")

edit /etc/motd to add OpenHack message: "eWEEK OpenHack system"

ensure date is correct, set if needed:
	date
	e.g. date 200210081403.10

install ntp:
	pkg_add ntp-4.1.72p1.tgz
	create /etc/ntp.conf
		"server time.nist.gov"

edit /etc/rc.conf
	set "ntpdate_flags=time.nist.gov"
	set "pf=YES"
	set "inetd=NO"

edit /etc/ssh/sshd_config
	add "Protocol 2" to require ver. 2.0 of SSH protocol
	add "ListenAddress 0.0.0.0" to have only a IPv4 listener

install symon ver. 2.52
	http://www.xs4all.nl/~wpd/mon/

==

further firewall configuration:

edit /etc/sysctl.conf
	uncomment "net.inet.ip.forwarding=1"

edit /etc/pf.conf
	add firewall rules

edit /etc/newsyslog.conf
	cp /etc/newsyslog.conf /etc/newsyslog.conf.orig
	set number of archives (ngen) column to "99999" for all log files

==

bridge setup

to see bridge status
	brconfig -a

to see addresses learned by the bridge
	brconfig bridge0 addr

to flush addresses
	brconfig bridge0 flush

==

mail server (sendmail) setup

man afterboot has sendmail config instructions
also try help

==

DNS setup

see what packages are installed
	pkg_info -a -c

see what install steps are done for bind
	pkg_add -n bind-9.2.1.tgz

(binaries go in /usr/local/bin -- dig, host, isc-config.sh, nslookup, nsupdate
and in /usr/local/sbin -- bind9-disable, bind9-enable, dnssec-*, lwresd, named*, rndc*, docs in /usr/local/share/doc/bind9 and /usr/local/share/examples,bind9)

install
	pkg_add -v bind-9.2.1.tgz

check:
	pkg_info -a

edit root environment to reference /usr/local/sbin before /usr/sbin so bind9 files are called instead of bind4 files in /usr/sbin

create bind configuration files in /var/named/etc and /var/named/etc/named
create directories /var/named/log and /var/named/run and make both writable by named user

add /var/named/etc/rndc.key
	rndc-confgen -a -t /var/named
	chown root.wheel /var/named/etc/rndc.key
	chmod +r-w /var/named/etc/rndc.key

check files
	/usr/local/sbin/named-checkconf named.conf
	/usr/local/sbin/named-checkzone openhack.com openhack.com.db
	/usr/local/sbin/named-checkzone 153.0.209.in-addr.arpa openhack.com.reverse.db

edit /etc/rc.conf
	set 'named_flags=""'
	set 'named_user=named' (default value)
	set 'named_chroot=/var/named' (default value)

edit named start line in /etc/rc
	/usr/local/sbin/named $named_flags

to start manually (/etc/rc starts it automatically on bootup)
	/usr/local/sbin/named -t /var/named -u named

rncd to operate
	/usr/local/sbin/rndc status
	/usr/local/sbin/rndc reload
	/usr/local/sbin/rndc stop

==

Web server setup

default version of Apache with OpenBSD 3.2 is 1.3.26

tar xvfz httpd-2.0.43.tar.gz
./configure --prefix=/usr/local/apache --disable-auth --disable-include --disable-env --disable-setenvif --disable-autoindex --disable-asis --disable-cgid --disable-cgi --disable-negotiation --disable-imap --disable-actions --disable-userdir --disable-alias --enable-info

(add --enable-info for just for testing)

make
make install

check compiled-in modules
	/usr/local/apache/bin/httpd -l

	get rid of mod_dir (DirectoryIndex On|Off), mod_imap (ImapMenu), mod_actions (Action, Script)

	should have exactly these modules:
		core.c			core server
		mod_access.c		needed to support "Order Deny,Allow"
		mod_log_config.c	needed to provide logging
		prefork.c		core server: using the process-based model
		http_core.c		core HTTP server
		mod_mime.c		needed to send the right MIME type for files based on their extensions
		mod_status.c		used to display server status
		mod_info.c		used to display server info
		mod_dir.c		needed to automatically return index.html
		mod_so.c		core server: Apache plugable module architecture

edit /usr/local/apache/conf/httpd.conf (use "highperformance.conf" as a starting point)

	ExtendedStatus On	(only for testing)

	Listen 80
	ServerRoot "/usr/local/apache"
	DocumentRoot = "/usr/local/apache/htdocs"
	User www
	Group www
	HostnameLookups Off
	Timeout 120
	KeepAlive On
	MaxKeepAliveRequests 100
	KeepAliveTimeout 15
	MaxRequestsPerChild 10000
	ServerLimit 2000

	MaxClients 2000
	StartServers 25
	MinSpareServers 25
	MaxSpareServers 100

	DirectoryIndex index.html
	DefaultType text/plain
	ServerSignature Off

	ErrorLog logs/error.log
	LogLevel warn
	CustomLog logs/access.log combined 	-- implies LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-agent}i\""

check config file
	/usr/local/apache/bin/httpd -t

edit /root/.profile
	list /usr/local/apache/bin before /usr/sbin to avoid calling built-in copy of Apache

to have Apache start automatically
	edit /etc/rc.conf
		set httpd_flags line to 'httpd_flags=""'
	edit /etc/rc
		change httpd start line to point to /usr/local/apache/bin/httpd

to start manually:
	/usr/local/apache/bin/apachectl start

==

to mount a floppy:
	mount /dev/fd0Bc /mnt			(see man fdc)

==
==

end of OpenHack shutdown

comment out pf stats collection lines in crontab
	crontab -e

kill symon
delete
	downloaded software (Apache, NTP, etc.)
	mail
	root/mbox
	/home/symon/*/*.rrd			(on www.openhack.com)

force rotation of all logs:
	newsyslog -F -v

compress Stats logs
	gzip /home/Stats/*_log			(on routers)

backup key files
	/root
	/home
	/var/log
	/etc files changed from the defaults
